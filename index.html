<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Calendar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --hint-color: var(--tg-theme-hint-color, #888);
            --btn-color: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #fff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --danger: #ff3b30;
            --weekend-bg: #fff0f0; /* –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö */
            --weekend-text: #d32f2f;
            --night-opacity: 0.5;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-color); color: var(--text-color); padding: 16px; margin: 0; padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –∫–Ω–æ–ø–∫—É */ }
        
        h3 { margin: 15px 0 10px 0; font-size: 16px; font-weight: 600; text-transform: uppercase; color: var(--hint-color); letter-spacing: 0.5px; }
        
        /* –ò–Ω—Ñ–æ –ø–∞–Ω–µ–ª—å */
        .timezone-info {
            background: var(--secondary-bg);
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
            margin-bottom: 20px;
            border-left: 4px solid var(--btn-color);
        }
        .tz-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .tz-label { color: var(--hint-color); }
        .tz-val { font-weight: bold; }

        /* --- –î–ê–¢–´ --- */
        .chips-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            margin-bottom: 5px;
            scrollbar-width: none;
        }
        .chips-scroll::-webkit-scrollbar { display: none; }

        .date-chip {
            background: var(--secondary-bg);
            padding: 10px 14px;
            border-radius: 12px;
            min-width: 60px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .date-chip span.day { font-size: 12px; opacity: 0.8; margin-bottom: 2px; }
        .date-chip span.num { font-size: 18px; font-weight: bold; }

        .date-chip.active { background: var(--btn-color); color: var(--btn-text); border-color: var(--btn-color); }
        
        /* –í—ã—Ö–æ–¥–Ω—ã–µ */
        .date-chip.weekend { background-color: var(--weekend-bg); color: var(--weekend-text); }
        .date-chip.weekend.active { background-color: var(--btn-color); color: white; }
        
        /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –Ω–µ–¥–µ–ª–∏ (–æ—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è) */
        .date-chip.sunday-end { margin-right: 20px; position: relative; }
        .date-chip.sunday-end::after {
            content: ''; position: absolute; right: -14px; top: 10%; height: 80%; width: 1px; background: #ddd;
        }

        /* --- –í–†–ï–ú–Ø (–°–ï–¢–ö–ê) --- */
        .time-section { margin-bottom: 15px; }
        .time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 –∫–æ–ª–æ–Ω–∫–∏ */
            gap: 8px;
        }

        .time-chip {
            background: var(--secondary-bg);
            padding: 10px 5px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }
        .time-chip.active { background: var(--btn-color); color: var(--btn-text); border-color: var(--btn-color); }

        .t-main { font-size: 17px; font-weight: bold; display: block; }
        .t-sub { font-size: 11px; opacity: 0.7; display: block; margin-top: 2px; }

        /* –ù–µ—É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è */
        .time-chip.night { opacity: var(--night-opacity); background: #eee; }
        .time-chip.night::after { content: 'üåë'; position: absolute; top: 2px; right: 2px; font-size: 10px; }

        /* --- –ü–û–õ–Ø –í–í–û–î–ê --- */
        .input-group { margin-top: 20px; }
        label { display: block; margin-bottom: 8px; color: var(--hint-color); font-size: 14px; }
        textarea {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid var(--secondary-bg);
            background: var(--secondary-bg);
            color: var(--text-color);
            font-size: 16px; box-sizing: border-box; outline: none; resize: vertical; min-height: 60px;
        }
        textarea:focus { border: 1px solid var(--btn-color); }

        /* --- –ö–ê–†–¢–û–ß–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø --- */
        .confirm-card {
            background: var(--secondary-bg);
            border-radius: 16px;
            padding: 15px;
            margin-top: 25px;
            border: 1px solid transparent;
            display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            animation: slideUp 0.3s ease-out;
        }
        .confirm-card.visible { display: block; border-color: var(--btn-color); }
        
        .cc-header { font-size: 12px; color: var(--hint-color); text-transform: uppercase; margin-bottom: 8px; }
        .cc-date { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .cc-time { font-size: 16px; margin-bottom: 5px; }
        .cc-sub { color: var(--hint-color); font-size: 13px; }
        .cc-highlight { color: var(--btn-color); font-weight: bold; }

        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* –°–∫—Ä—ã—Ç—ã–µ –∏–Ω–ø—É—Ç—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π */
        .hidden-inputs { display: none; }
    </style>
</head>
<body>

    <div class="timezone-info">
        <div class="tz-row">
            <span class="tz-label">–ö–∞–Ω–¥–∏–¥–∞—Ç:</span>
            <span class="tz-val" id="cityDisplay">...</span>
        </div>
        <div class="tz-row">
            <span class="tz-label">–†–∞–∑–Ω–∏—Ü–∞:</span>
            <span class="tz-val" id="diffDisplay">...</span>
        </div>
    </div>

    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h3>
    <div class="chips-scroll" id="dateChips"></div>

    <div id="timeContainer">
        </div>

    <div class="input-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –ê–¥—Ä–µ—Å</label>
        <textarea id="commentInput" placeholder="–û—Ñ–∏—Å 205, —Å–ø—Ä–æ—Å–∏—Ç—å –û–ª—å–≥—É..."></textarea>
    </div>

    <div class="confirm-card" id="confirmCard">
        <div class="cc-header">–ò—Ç–æ–≥–æ–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
        <div class="cc-date" id="ccDate">...</div>
        <div class="cc-time" id="ccTime">...</div>
        <div class="cc-sub">–ö–∞–Ω–¥–∏–¥–∞—Ç: <span id="ccCandidate">–ò–≤–∞–Ω</span></div>
    </div>

    <div class="hidden-inputs">
        <input type="date" id="dateInput">
        <input type="time" id="timeInput">
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.text = "–ó–ê–ü–ò–°–ê–¢–¨";
        
        // --- –ü–ê–†–ê–ú–ï–¢–†–´ –ò–ó TELEGRAM (startapp) ---
        // –§–æ—Ä–º–∞—Ç: {candidate_id}_{city_key}_{utc_offset}_{recruiter_id}
        const startParam = tg.initDataUnsafe.start_param || "";
        const params = startParam.split('_');
        const candidateId = params[0] || null;
        const cityKey = params[1] || "";
        const utcOffset = params[2] ? parseFloat(params[2]) : 3;
        const recruiterId = params[3] || null;
        
        // --- –ü–ê–†–ê–ú–ï–¢–†–´ URL (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) ---
        const urlParams = new URLSearchParams(window.location.search);
        const MOSCOW_OFFSET = 3; 
        const targetOffset = urlParams.get('offset') ? parseFloat(urlParams.get('offset')) : utcOffset;
        const cityName = urlParams.get('city') || cityKey || '–ú–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è';
        const candidateName = urlParams.get('name') || '–ö–∞–Ω–¥–∏–¥–∞—Ç';

        // –†–∞–∑–Ω–∏—Ü–∞: –ö–∞–Ω–¥–∏–¥–∞—Ç(5) - –ú–°–ö(3) = +2. 
        // –ï—Å–ª–∏ —É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ 14:00, —Ç–æ –ø–æ –ú–°–ö = 14 - 2 = 12:00.
        const diffHours = targetOffset - MOSCOW_OFFSET;
        
        console.log('üì± Telegram params:', { candidateId, cityKey, utcOffset, recruiterId });

        const dateInput = document.getElementById('dateInput');
        const timeInput = document.getElementById('timeInput');
        const confirmCard = document.getElementById('confirmCard');

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        let selectedDateObj = null; 
        let selectedTimeStr = null;

        function init() {
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω. –¥–∞—Ç—ã
            const now = new Date();
            dateInput.min = now.toISOString().split('T')[0];

            // –ò–Ω—Ñ–æ
            document.getElementById('cityDisplay').textContent = `${cityName} (UTC${targetOffset >= 0 ? '+' : ''}${targetOffset})`;
            document.getElementById('ccCandidate').textContent = candidateName;

            const diffElem = document.getElementById('diffDisplay');
            if (diffHours === 0) {
                diffElem.textContent = "–í—Ä–µ–º—è –ú–°–ö";
                diffElem.style.color = "green";
            } else {
                const sign = diffHours > 0 ? "+" : "";
                diffElem.textContent = `${sign}${diffHours} —á. –æ—Ç –ú–°–ö`;
                diffElem.style.color = "var(--btn-color)";
            }

            renderDateChips();
            renderTimeSections(); // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
            
            // –°–ª–µ–¥–∏–º –∑–∞ –∫–æ–º–º–µ–Ω—Ç–æ–º
            document.getElementById('commentInput').addEventListener('input', updateConfirmCard);
        }

        // --- –†–ï–ù–î–ï–† –î–ê–¢ ---
        function renderDateChips() {
            const container = document.getElementById('dateChips');
            const daysShort = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 14 –¥–Ω–µ–π
            for (let i = 0; i < 14; i++) {
                const d = new Date();
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const dayOfWeek = d.getDay(); // 0 - –í—Å, 6 - –°–±
                
                let dayLabel = daysShort[dayOfWeek];
                if (i === 0) dayLabel = "–°–µ–≥–æ–¥–Ω—è";
                if (i === 1) dayLabel = "–ó–∞–≤—Ç—Ä–∞";

                const chip = document.createElement('div');
                chip.className = 'date-chip';
                
                // 1. –í–∏–∑—É–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏ (–í—ã—Ö–æ–¥–Ω—ã–µ)
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    chip.classList.add('weekend');
                }
                // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –Ω–µ–¥–µ–ª—å –ø–æ—Å–ª–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è
                if (dayOfWeek === 0) {
                    chip.classList.add('sunday-end');
                }

                chip.innerHTML = `<span class="day">${dayLabel}</span><span class="num">${d.getDate()}</span>`;
                
                chip.onclick = () => {
                    document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    dateInput.value = dateStr;
                    selectedDateObj = d;
                    updateConfirmCard();
                };
                container.appendChild(chip);
            }
        }

        // --- –†–ï–ù–î–ï–† –í–†–ï–ú–ï–ù–ò (–ì–†–£–ü–ü–ò–†–û–í–ö–ê) ---
        function renderTimeSections() {
            const container = document.getElementById('timeContainer');
            
            // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–æ–≤
            const sections = [
                { id: 'morning', title: 'üåÖ –£—Ç—Ä–æ', range: [9, 10, 11] },
                { id: 'day', title: '‚òÄÔ∏è –î–µ–Ω—å', range: [12, 13, 14, 15, 16] },
                { id: 'evening', title: 'üåÜ –í–µ—á–µ—Ä', range: [17, 18, 19, 20] }
            ];

            sections.forEach(sec => {
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                const header = document.createElement('h3');
                header.textContent = sec.title;
                container.appendChild(header);

                // –°–µ—Ç–∫–∞
                const grid = document.createElement('div');
                grid.className = 'time-grid';

                sec.range.forEach(hour => {
                    const chip = createTimeChip(hour);
                    grid.appendChild(chip);
                });

                container.appendChild(grid);
            });
        }

        function createTimeChip(hour) {
            const timeStr = `${hour < 10 ? '0'+hour : hour}:00`;
            const chip = document.createElement('div');
            chip.className = 'time-chip';

            // 2. –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞ (–ú–°–ö)
            // –í—Ä–µ–º—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (hour) - –†–∞–∑–Ω–∏—Ü–∞ = –í—Ä–µ–º—è –ú–°–ö
            // –ü—Ä–∏–º–µ—Ä: –ö–∞–Ω–¥–∏–¥–∞—Ç 09:00 (UTC+5), –ú–°–ö (UTC+3). –†–∞–∑–Ω–∏—Ü–∞ +2.
            // –ú–°–ö = 9 - 2 = 7:00.
            let mskHour = hour - diffHours;
            
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–µ—Ä–µ—à–ª–∏ —á–µ—Ä–µ–∑ —Å—É—Ç–∫–∏, —Ö–æ—Ç—è –¥–ª—è 9-20 —ç—Ç–æ —Ä–µ–¥–∫–æ—Å—Ç—å, –Ω–æ –≤—Å—ë –∂–µ)
            if (mskHour < 0) mskHour += 24; 
            if (mskHour >= 24) mskHour -= 24;

            const mskTimeStr = `${mskHour < 10 ? '0'+mskHour : mskHour}:00`;

            // 3. –ò–Ω–¥–∏–∫–∞—Ü–∏—è "–ù–µ—É–¥–æ–±–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏" (–ù–æ—á—å –¥–ª—è —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞)
            // –î–æ–ø—É—Å—Ç–∏–º, –Ω–µ—É–¥–æ–±–Ω–æ —Ä–∞–Ω—å—à–µ 8:00 –∏ –ø–æ–∑–∂–µ 22:00
            if (mskHour < 8 || mskHour >= 22) {
                chip.classList.add('night');
            }

            // HTML —á–∏–ø—Å–∞ (–î–≤–æ–π–Ω–æ–µ –≤—Ä–µ–º—è)
            chip.innerHTML = `
                <span class="t-main">${timeStr}</span>
                <span class="t-sub">–≤–∞—à–µ: ${mskTimeStr}</span>
            `;

            chip.onclick = () => {
                document.querySelectorAll('.time-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                timeInput.value = timeStr;
                selectedTimeStr = timeStr;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º "–í–∞—à–µ –≤—Ä–µ–º—è" –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
                chip.dataset.msk = mskTimeStr;
                
                updateConfirmCard();
            };

            return chip;
        }

        // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–û–ß–ö–ò ---
        function updateConfirmCard() {
            if (!dateInput.value || !timeInput.value) {
                tg.MainButton.hide();
                confirmCard.classList.remove('visible');
                return;
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É: "–°—Ä–µ–¥–∞, 22 –º–∞—è"
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            const dateText = selectedDateObj.toLocaleDateString('ru-RU', options);
            // –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∑–∞–≥–ª–∞–≤–Ω–æ–π
            const dateTextCap = dateText.charAt(0).toUpperCase() + dateText.slice(1);

            // –í—Ä–µ–º—è
            const activeTimeChip = document.querySelector('.time-chip.active');
            const mskTime = activeTimeChip ? activeTimeChip.dataset.msk : '??';

            document.getElementById('ccDate').textContent = dateTextCap;
            document.getElementById('ccTime').innerHTML = `
                <span class="cc-highlight">${selectedTimeStr}</span> (–ø–æ –º–µ—Å—Ç–Ω–æ–º—É)<br>
                <small>${mskTime} (–ø–æ –≤–∞—à–µ–º—É)</small>
            `;

            confirmCard.classList.add('visible');
            tg.MainButton.show();
        }

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –û–¢–ü–†–ê–í–ö–ê ---
        function isValidTime() {
            if (!dateInput.value || !timeInput.value) return false;
            
            const [year, month, day] = dateInput.value.split('-').map(Number);
            const [hours, minutes] = timeInput.value.split(':').map(Number);

            // UTC –≤—Å—Ç—Ä–µ—á–∏
            const meetingUTC = Date.UTC(year, month - 1, day, hours, minutes) - (targetOffset * 60 * 60 * 1000);
            const nowUTC = Date.now();

            return meetingUTC >= nowUTC;
        }

        tg.MainButton.onClick(function() {
            const date = dateInput.value;
            const time = timeInput.value;
            const comment = document.getElementById('commentInput').value;

            if (!date || !time) return;

            if (!isValidTime()) {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: '–≠—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ!',
                    buttons: [{type: 'ok'}]
                });
                return;
            }

            tg.MainButton.showProgress();

            const fullStr = `${date} –≤ ${time} (${cityName})`;
            
            // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –î–∞–Ω–Ω—ã–µ –¥–ª—è –±–æ—Ç–∞ —Å candidate_id
            const data = {
                candidate_id: candidateId,  // ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
                date: date,
                time: time,
                comment: comment || "",
                full_str: fullStr
            };
            
            console.log('üì§ Sending data to bot:', data);
            tg.sendData(JSON.stringify(data));
        });

        init();
        
        // –¶–≤–µ—Ç–∞
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
        document.body.style.color = tg.themeParams.text_color || '#000000';

    </script>
</body>
</html>
